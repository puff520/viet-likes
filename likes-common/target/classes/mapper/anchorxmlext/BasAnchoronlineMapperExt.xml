<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.likes.common.mybatis.mapperext.anchor.BasAnchoronlineMapperExt">

    <resultMap id="BaseResultMap" type="com.likes.common.mybatis.entity.anchor.BasAnchoronline">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="anconlineid" jdbcType="BIGINT" property="anconlineid"/>
        <result column="roomid" jdbcType="BIGINT" property="roomid"/>
        <result column="clientid" jdbcType="VARCHAR" property="clientid"/>
        <result column="server" jdbcType="VARCHAR" property="server"/>
        <result column="accno" jdbcType="VARCHAR" property="accno"/>
        <result column="nickname" jdbcType="VARCHAR" property="nickname"/>
        <result column="is_delete" jdbcType="BIT" property="isDelete"/>
        <result column="onlinedate" jdbcType="TIMESTAMP" property="onlinedate"/>
        <result column="offlinedate" jdbcType="TIMESTAMP" property="offlinedate"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>

    <select id="getLastOnlineTime" parameterType="java.lang.Long" resultType="com.likes.common.model.dto.bas.LastOnlineTimeDO">
        SELECT ba.roomid as roomId, ba.onlinedate as onlineDate, ba.offlinedate as offlineDate
        FROM bas_anchoronline ba
        WHERE ba.roomid = #{roomId}
        and ba.is_delete = b'0'
        order by ba.onlinedate desc
        limit 1
    </select>

    <select id="getOnlineStaticsByTime" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM bas_anchoronline ba
        WHERE <![CDATA[ ba.onlinedate >= #{param1} ]]>
        AND <![CDATA[ ba.onlinedate < #{param2} ]]>
        AND ba.is_delete = b'0'
    </select>

    <!--<select id="getDayStatics" parameterType="java.lang.String" resultType="com.likes.common.model.dto.NameValueDO">-->
    <!--<![CDATA[-->

    <!--SELECT COUNT(1) AS value , "00:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;=  date_sub(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 1 hour)-->
    <!--AND  ba.onlinedate < STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s')-->
    <!--AND ba.is_delete = b'0'-->

    <!--) AS AA0-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , "04:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s')-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 4 hour)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA1-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , "08:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 4 hour)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 8 hour)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA2-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , "12:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 8 hour)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 12 hour)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA3-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , "16:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 12 hour)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 16 hour)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA4-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , "20:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 16 hour)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 20 hour)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA5-->


    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , "24:00" as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 20 hour)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 24 hour)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA6-->

    <!--]]>-->
    <!--</select>-->

    <!--<select id="getMonthStatics"-->
    <!--parameterType="java.lang.String"-->
    <!--resultType="com.likes.common.model.dto.NameValueDO">-->
    <!--<![CDATA[-->


    <!--SELECT COUNT(1) AS value , DATE_FORMAT(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_sub(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 1 day)-->
    <!--AND ba.onlinedate < STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s')-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA0-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 5 day),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s')-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 5 day)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA1-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 10 day),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 5 day)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 10 day)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA2-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 15 day),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 10 day)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 15 day)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA3-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 20 day),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 15 day)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 20 day)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA4-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 25 day),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 20 day)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 25 day)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA5-->


    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 30 day),'%Y-%m-%d') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 25 day)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 30 day)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA6-->

    <!--]]>-->
    <!--</select>-->


    <!--<select id="getYearStatics" parameterType="java.lang.String"-->
    <!--resultType="com.likes.common.model.dto.NameValueDO">-->
    <!--<![CDATA[-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_sub(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 1 day)-->
    <!--AND ba.onlinedate < STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s')-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA0-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 2 month),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate >= STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s')-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 2 month)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA1-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 4 month),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 2 month)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 4 month)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA2-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 6 month),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 4 month)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 6 month)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA3-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 8 month),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 6 month)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 8 month)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA4-->

    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 10 month),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 8 month)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 10 month)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA5-->


    <!--UNION ALL-->

    <!--SELECT COUNT(1) AS value , DATE_FORMAT(date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 12 month),'%Y-%m') as name-->
    <!--FROM (-->
    <!--SELECT ba.accno-->
    <!--from bas_anchoronline ba-->
    <!--WHERE ba.onlinedate-->
    <!--&gt;= date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 10 month)-->
    <!--AND ba.onlinedate < date_add(STR_TO_DATE(#{day},'%Y-%m-%d %H:%i:%s'), interval 12 month)-->
    <!--AND ba.is_delete = b'0'-->
    <!--) AS AA6-->


    <!--]]>-->
    <!--</select>-->

    <!--<select id="getBasAnchoronlineByPretime" parameterType="com.likes.common.model.request.FamilyStatisticsRequest"-->
    <!--resultMap="BaseResultMap">-->
    <!--SELECT *-->
    <!--FROM bas_anchoronline b-->
    <!--WHERE b.accno IN-->
    <!--<foreach close=")" collection="anchorAccnoList" index="index" item="s" open="(" separator=",">-->
    <!--#{s}-->
    <!--</foreach>-->
    <!--AND b.offlinedate is not null-->
    <!--<![CDATA[-->
    <!--AND b.offlinedate > #{pretime}-->
    <!--AND b.onlinedate < #{pretime}  ]]>-->
    <!--</select>-->

    <select id="getBasAnchoronlinetime" parameterType="com.likes.common.model.request.FamilyStatisticsRequest" resultMap="BaseResultMap">
        SELECT *
        FROM bas_anchoronline b
        WHERE b.accno IN
        <foreach close=")" collection="anchorAccnoList" index="index" item="s" open="(" separator=",">
            #{s}
        </foreach>
        AND b.offlinedate is not null
        <![CDATA[ AND b.offlinedate <= #{endtime} ]]>
        <if test="pretime != null and pretime !=''  ">
            <![CDATA[ AND b.onlinedate > #{pretime} ]]>
        </if>
    </select>

    <!--<select id="getBasAnchoronlineByThistime" parameterType="com.likes.common.model.request.FamilyStatisticsRequest"-->
    <!--resultMap="BaseResultMap">-->
    <!--SELECT *-->
    <!--FROM bas_anchoronline b-->
    <!--WHERE b.accno IN-->
    <!--<foreach close=")" collection="anchorAccnoList" index="index" item="s" open="(" separator=",">-->
    <!--#{s}-->
    <!--</foreach>-->
    <!--AND b.offlinedate is not null-->
    <!--<![CDATA[ AND b.offlinedate <= #{endtime} ]]>-->
    <!--<if test="pretime != null and pretime !='' ">-->
    <!--<![CDATA[ AND b.onlinedate > #{pretime} ]]>-->
    <!--</if>-->
    <!--order by onlinedate asc-->
    <!--</select>-->

    <select id="getByRoomid" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select *
        from bas_anchoronline
        where  roomid = #{roomid}
        and is_delete = b'0'
        order by onlinedate desc
        limit 1
    </select>

    <update id="initOnlineStatus">
        update bas_anchoronline
        set offlinedate = now()
        where offlinedate is null
        and is_delete = b'0'
    </update>

    <update id="updateByParam" parameterType="com.likes.common.mybatis.entity.anchor.BasAnchoronline">
        update bas_anchoronline
        set offlinedate = #{offlinedate,jdbcType=TIMESTAMP}
        where accno = #{accno,jdbcType=VARCHAR}
        and roomid = #{roomid,jdbcType=BIGINT}
        and clientid = #{clientid,jdbcType=VARCHAR}
        and offlinedate is null
        and is_delete = b'0'
    </update>

    <select id="getOnlineList" parameterType="com.likes.common.model.request.UserRequest"
            resultType="com.likes.common.model.vo.member.BasAnchoronlineVO">
        SELECT DATE_FORMAT(b.onlinedate,'%Y-%m-%d') as day,ml.acclogin,b.*,
        ifnull(round(TIME_TO_SEC(TIMEDIFF(ifnull(b.offlinedate,NOW()),b.onlinedate))/60,2),0) as duration
        FROM bas_anchoronline b
        INNER JOIN anchor_mem_login ml on b.accno = ml.accno
        <if test="acclogin != null and acclogin !=''  ">
            <![CDATA[ AND ml.acclogin = #{acclogin} ]]>
        </if>
        WHERE b.offlinedate is not null
        <if test="startTime != null and startTime !='' ">
            AND b.onlinedate <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime != null and endTime !='' ">
            AND b.onlinedate <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="nickname != null and nickname !='' ">
            AND b.nickname LIKE CONCAT('%',#{nickname,jdbcType=VARCHAR},'%')
        </if>
        ORDER BY b.onlinedate DESC
    </select>

    <select id="selectTraAnchoronline" parameterType="java.lang.Long" resultType="com.likes.common.model.dto.TraAnchorDO">
        SELECT ba.onlinedate,ba.offlinedate,
        (SELECT nickname FROM anchor_mem_baseinfo mb WHERE mb.accno = ba.accno LIMIT 1) as nickname
        FROM bas_anchoronline ba
        WHERE ba.anconlineid = #{anconlineid}
        and ba.is_delete = b'0'
    </select>

</mapper>