<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.likes.common.mybatis.mapperext.tra.TraApplycashMapperExt">
    <resultMap id="BaseResultMap" type="com.likes.common.mybatis.entity.TraApplycash">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="apycid" jdbcType="BIGINT" property="apycid"/>
        <result column="bankaccid" jdbcType="BIGINT" property="bankaccid"/>
        <result column="orderid" jdbcType="BIGINT" property="orderid"/>
        <result column="accno" jdbcType="VARCHAR" property="accno"/>
        <result column="apycdate" jdbcType="TIMESTAMP" property="apycdate"/>
        <result column="apycgold" jdbcType="DECIMAL" property="apycgold"/>
        <result column="apycamt" jdbcType="DECIMAL" property="apycamt"/>
        <result column="apycstatus" jdbcType="DECIMAL" property="apycstatus"/>
        <result column="paymemname" jdbcType="VARCHAR" property="paymemname"/>
        <result column="paydate" jdbcType="TIMESTAMP" property="paydate"/>
        <result column="is_delete" jdbcType="BIT" property="isDelete"/>
        <result column="create_user" jdbcType="VARCHAR" property="createUser"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_user" jdbcType="VARCHAR" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="damaliang" jdbcType="DECIMAL" property="damaliang"/>
        <result column="xingzhengfei" jdbcType="DECIMAL" property="xingzhengfei"/>
        <result column="bet_amount" jdbcType="DECIMAL" property="betAmount"/>
        <result column="no_withdrawal_amount" jdbcType="DECIMAL" property="noWithdrawalAmount"/>
        <result column="payimg" jdbcType="VARCHAR" property="payimg"/>
        <result column="ordertype" jdbcType="DECIMAL" property="ordertype"/>
    </resultMap>
    <sql id="Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <where>
            <foreach collection="oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        apycid, bankaccid, orderid, accno, apycdate, apycgold, apycamt, apycstatus, paymemname,
        paydate, is_delete, create_user, create_time, update_user, update_time, damaliang,
        xingzhengfei, bet_amount, no_withdrawal_amount,payimg, ordertype
    </sql>
    <select id="findByOrderid" parameterType="java.lang.Long" resultMap="BaseResultMap">

        select

        <include refid="Base_Column_List"/>

        from tra_applycash
        where orderid = #{orderid}
        and is_delete = b'0'
        limit 1

    </select>

    <update id="doUpdateIncarnateHandleOrder" parameterType="com.likes.common.mybatis.entity.TraApplycash">

	  update tra_applycash
	    set
	      apycstatus = #{apycstatus,jdbcType=DECIMAL},
	      paymemname = #{paymemname,jdbcType=VARCHAR},
	      update_user = #{updateUser,jdbcType=VARCHAR}
	    where apycid = #{apycid,jdbcType=BIGINT}
	    AND apycstatus = 1
	     AND is_delete = b'0'

    </update>

    <update id="doUpdateIncarnateCancelSureOrder" parameterType="com.likes.common.mybatis.entity.TraApplycash">

	  update tra_applycash
	    set
	      apycstatus = #{apycstatus,jdbcType=DECIMAL},
	      paymemname = NULL ,
	      update_user = #{updateUser,jdbcType=VARCHAR}
	    where apycid = #{apycid,jdbcType=BIGINT}
	    AND apycstatus = 2
	     AND is_delete = b'0'

    </update>

    <update id="updateIncarnateConfirmApplycash" parameterType="com.likes.common.mybatis.entity.TraApplycash">

	  update tra_applycash
	    set
	      apycstatus = #{apycstatus,jdbcType=DECIMAL},
	      apycdate = #{apycdate,jdbcType=TIMESTAMP},
	      paydate = #{apycdate,jdbcType=TIMESTAMP},
	      update_user = #{updateUser,jdbcType=VARCHAR},
	      paymemname = #{paymemname,jdbcType=VARCHAR}
	    where apycid = #{apycid,jdbcType=BIGINT}
	    AND apycstatus = 2
	     AND is_delete = b'0'

    </update>


    <update id="udunUpdateIncarnateConfirmApplycash" parameterType="com.likes.common.mybatis.entity.TraApplycash">

        update tra_applycash
        set
            apycstatus = #{apycstatus,jdbcType=DECIMAL},
            apycdate = #{apycdate,jdbcType=TIMESTAMP},
            paydate = #{apycdate,jdbcType=TIMESTAMP},
            update_user = #{updateUser,jdbcType=VARCHAR},
            paymemname = #{paymemname,jdbcType=VARCHAR}
        where apycid = #{apycid,jdbcType=BIGINT}
          AND is_delete = b'0'

    </update>

    <select id="getTraApplycashList" parameterType="com.likes.common.model.request.FamilyIncarnateRequest"
            resultType="com.likes.common.model.dto.TraApplycashDO">
        select t.accno,t.apycamt,t.apycdate,t.apycid,t.apycstatus,t.update_time as updateTime,t.orderid,t.paymemname as modifyusername,f.orderstatus,f.ordertype,f.payimg as payimgurl
        from tra_applycash t INNER JOIN tra_orderinfom f on f.orderid = t.orderid and f.ordertype in (12,13)
        where t.accno = #{accno} and t.apycstatus in (2,4)
        <if test="starttime != null  and starttime != ''">
          AND t.update_user &gt;= #{starttime}
        </if>
        <if test="endtime != null and endtime != ''">
          AND #{endtime} &gt;= t.update_user
        </if>
        order by t.create_time desc
    </select>

    <select id="getLastTraApplycash" parameterType="java.lang.String" resultType="com.likes.common.mybatis.entity.TraApplycash">

        select * from tra_applycash t
        where t.accno = #{accno} and t.apycstatus != 9
        order by apycdate desc
        limit 1

    </select>
    <insert id="doInsert" keyColumn="apycid" keyProperty="apycid" parameterType="com.likes.common.mybatis.entity.TraApplycash" useGeneratedKeys="true">

    insert into tra_applycash (bankaccid, orderid,
      accno, apycdate, apycgold,
      apycamt, apycstatus, paymemname,
      damaliang,xingzhengfei,
      paydate,  create_user, update_user)
    values (#{bankaccid,jdbcType=BIGINT}, #{orderid,jdbcType=BIGINT},
      #{accno,jdbcType=VARCHAR}, #{apycdate,jdbcType=TIMESTAMP}, #{apycgold,jdbcType=BIGINT},
      #{apycamt,jdbcType=DECIMAL}, #{apycstatus,jdbcType=DECIMAL}, #{paymemname,jdbcType=VARCHAR},
      #{damaliang,jdbcType=DECIMAL}, #{xingzhengfei,jdbcType=DECIMAL},
      #{paydate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}, #{updateUser,jdbcType=VARCHAR})

    </insert>

    <insert id="doInsertIncarnate" keyColumn="apycid" keyProperty="apycid" parameterType="com.likes.common.mybatis.entity.TraApplycash" useGeneratedKeys="true">

    insert into tra_applycash (bankaccid, orderid,
      accno, apycdate, apycgold,
      apycamt, apycstatus, paymemname,
      damaliang,xingzhengfei,no_withdrawal_amount,
      paydate,  create_user, update_user)

    SELECT
    #{bankaccid,jdbcType=BIGINT}, #{orderid,jdbcType=BIGINT},
      #{accno,jdbcType=VARCHAR}, #{apycdate,jdbcType=TIMESTAMP}, #{apycgold,jdbcType=BIGINT},
      #{apycamt,jdbcType=DECIMAL}, #{apycstatus,jdbcType=DECIMAL}, #{paymemname,jdbcType=VARCHAR},
      #{damaliang,jdbcType=DECIMAL}, #{xingzhengfei,jdbcType=DECIMAL}, #{noWithdrawalAmount,jdbcType=DECIMAL},
      #{paydate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=VARCHAR}, #{updateUser,jdbcType=VARCHAR}
    WHERE
	    NOT EXISTS
	    (SELECT accno
		from tra_applycash
	    where accno = #{accno}
	    AND apycstatus in (1,2)
	    AND is_delete = b'0'
	    limit 1)


    </insert>

    <update id="updateTraApplycash" parameterType="com.likes.common.mybatis.entity.TraApplycash">

      update tra_applycash
        set
          apycstatus = #{apycstatus,jdbcType=DECIMAL},
          update_user = #{updateUser,jdbcType=VARCHAR}
        where apycid = #{apycid,jdbcType=BIGINT}
        AND is_delete = b'0'
        AND apycstatus = 1

    </update>

      <select id="getIncarnateRecordList" parameterType="java.lang.String"
            resultType="com.likes.common.model.response.IncarnateRecordResponse">
        SELECT A.accounttype, A.accountname,A.accountno,
        A.bankname,A.bankaddress,B.orderid,B.apycamt,B.paydate,B.apycdate,B.apycgold,B.apycstatus
        FROM
        (SELECT mb.bankaccid,mb.accounttype,mb.accountname,mb.accountno,mb.bankname,mb.bankaddress
        FROM mem_bankaccount mb
        WHERE mb.accno = #{accno}
        ) AS A
        ,
        (SELECT  tr.apycgold,tr.paydate,tr.apycdate,tr.apycstatus,
        tr.orderid,tr.apycamt,tr.bankaccid,tr.paymemname,tr.apycid
        FROM tra_applycash tr
        WHERE tr.accno = #{accno}
        AND tr.is_delete = b'0'
--         AND tr.apycstatus = 4
--          AND tr.apycstatus in(1,2,4,8)
        ) AS B
        WHERE A.bankaccid = B.bankaccid
        ORDER BY B.paydate DESC
    </select>


    <!-- 关联订单查到实际支付 -->
    <select id="getIncarnateRecordListTotal" parameterType="java.lang.String" resultType="java.lang.Double">

        SELECT IFNULL(SUM(B.sumamt),0) FROM
        <!-- (
        SELECT  mg.refid,mg.quantity FROM mem_goldchange mg
        WHERE mg.is_delete = b'0'
        AND mg.accno = #{accno}
        AND mg.changetype = 10 ) AS A
        ,  -->
        (SELECT tr.apycgold,tr.paydate,tr.apycdate,
        tr.orderid,tr.apycamt,tr.bankaccid,tr.paymemname,tr.apycid,
        (SELECT tm.sumamt FROM tra_orderinfom tm WHERE
        tm.orderid = tr.orderid and tm.is_delete = b'0' AND tm.ordertype not in ("ord06") LIMIT 1) as sumamt
        FROM tra_applycash tr
        WHERE tr.accno = #{accno}
        AND tr.is_delete = b'0'
        AND tr.apycstatus not in (9)
        ) AS B
        <!-- WHERE A.refid = B.orderid
        ORDER BY B.paydate DESC -->
    </select>

    <select id="getXianshiIncarnateRecordListTotal" parameterType="java.lang.String" resultType="java.lang.Double">

        SELECT IFNULL(SUM(B.realamt),0) FROM
		(SELECT tr.apycgold,tr.paydate,tr.apycdate,
		tr.orderid,tr.apycamt,tr.bankaccid,tr.paymemname,tr.apycid,
		(SELECT tm.realamt
		FROM tra_orderinfom tm WHERE
		tm.orderid = tr.orderid and tm.is_delete = b'0' AND tm.ordertype not in ("ord06")  LIMIT 1) as realamt
		FROM tra_applycash tr
		WHERE tr.accno = #{accno}
		AND tr.is_delete = b'0'
		AND tr.apycstatus not in (9)
		) AS B

    </select>

    <!--是否 存在  申请状态  1提交申请  2提现处理中  的提现记录 -->
    <select id="findCashByCash" parameterType="com.likes.common.mybatis.entity.TraApplycash" resultType="com.likes.common.mybatis.entity.TraApplycash">

        select

        <include refid="Base_Column_List"/>

        from tra_applycash
        where accno = #{accno}
        AND apycstatus in (1,2)
        AND is_delete = b'0'
        limit 1

    </select>

    <select id="findNotInCashByCash" parameterType="java.util.Map" resultType="com.likes.common.mybatis.entity.TraApplycash">

		SELECT * FROM (
				SELECT
				   *
				    from tra_applycash
				    where accno = #{accno}
				    AND apycstatus in (1,2)
				    AND is_delete = b'0'

			UNION ALL

				SELECT
				   *
				    from tra_applycash
				    where accno = #{accno}
				    AND apycstatus  not in (9)
				    AND is_delete = b'0'
						AND(
						update_time BETWEEN #{starttime} AND #{endtime}
						OR
						paydate BETWEEN #{starttime} AND #{endtime}
						)
				) AS A

				LIMIT 1

    </select>

    <select id="getTraApplycashMemFamilyList" parameterType="java.lang.String"
            resultType="com.likes.common.model.dto.TraApplycashDO">

        select
        t.apycid, t.apycamt,t.apycstatus,f.ordertype

        from tra_applycash t INNER JOIN tra_orderinfom f on f.orderid = t.orderid and f.ordertype in (12,13)
        where t.accno = #{accno} and t.apycstatus in (1,2)
        order by t.create_time desc

    </select>

    <select id="findNotInCashByCashByAccno" parameterType="java.lang.String" resultType="com.likes.common.mybatis.entity.TraApplycash">

        SELECT * FROM (
        SELECT
        *
        from tra_applycash
        where accno = #{accno}
        AND apycstatus in (1,2)
        AND is_delete = b'0'
        <!-- UNION ALL
            SELECT
               *
                from tra_applycash
                where accno = #{accno}
                AND apycstatus  not in (9)
                AND is_delete = b'0' -->
        ) AS A
        LIMIT 1

    </select>
<!--auto generated by MybatisCodeHelper on 2020-07-24-->
    <select id="findByBankaccid" resultMap="BaseResultMap">
        select <include refid="Base_Column_List"/>
        from tra_applycash
        where is_delete = b'0' and bankaccid=#{bankaccid,jdbcType=BIGINT}
    </select>
</mapper>
